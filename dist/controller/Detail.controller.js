sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/m/MessageToast","../view/ApproversFlow"],function(e,t,s,i,o){"use strict";var n="";var r=[];return e.extend("invoiceapproval_S4Hana.controller.Detail",{formatter:s,onInit:function(){var e=new t({busy:false,delay:0,lineItemListTitle:this.getResourceBundle().getText("detailLineItemTableHeading")});this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);this.setModel(e,"detailView");this.getOwnerComponent().getModel().metadataLoaded().then(this._onMetadataLoaded.bind(this));this.createDeviceModel()},onDownloadItem:function(){var e=this.byId("uploadCollection");var t=e.getSelectedItems();if(t){for(var s=0;s<t.length;s++){var o=t[0].mProperties.url;window.open(o,"toolbar=yes,scrollbars=yes,resizable=yes,top=100,left=500,width=800,height=400")}}else{i.show("Select an item to download")}},updateCountPosition:function(){var e=this.getView().byId("TablePosition").getItems().length;var t={countPosition:e};var s=new sap.ui.model.json.JSONModel(t);this.getView().setModel(s,"tabFilterModel")},onVendorLaunchTask:function(e){var t=this.getView().getModel("extendedJsonModel").getData().VendorCode;var s=this.getOwnerComponent().getModel("RDAPROCESSING");s.setDefaultCountMode(false);s.setSizeLimit(9999);this.getOwnerComponent().setModel(s,"PrExtendedModel");this.getView().getModel().setSizeLimit(9999);sap.ui.core.BusyIndicator.show();s.read("/VendorInformationsSet(VendorCode='"+t+"')",{success:function(e){sap.ui.core.BusyIndicator.hide();var t=new sap.ui.model.json.JSONModel(e);this.getView().setModel(t,"VendorInformationsModel");if(!this.byId("ExtNewLblVendorDetailsDialog")){sap.ui.core.Fragment.load({id:this.getView().getId(),name:"invoiceapproval_S4Hana.view.VendorDetails",controller:this}).then(function(e){this.getView().addDependent(e);e.open()}.bind(this))}else{this.getView().byId("ExtNewLblVendorDetailsDialog").open()}}.bind(this),error:function(e){sap.ui.core.BusyIndicator.hide();alert("404: Comunication Failed")}.bind(this)})},createDeviceModel:function(){var e=sap.ui.Device;var t=new sap.ui.model.json.JSONModel(e);this.getView().setModel(t,"deviceModel")},onPressShowMore:function(e){var t=e.getSource().getParent().getParent().getParent().getBindingContextPath();var s=this.getView().getModel("extendedJsonModel").getProperty(t);s.showAllRows=!s.showAllRows;this.getView().getModel("extendedJsonModel").refresh(true)},checkBlocksRelease:function(e){if(!this._oDialog){this._oDialog=sap.ui.xmlfragment("invoiceapproval_S4Hana.view.DecisionStep",this);this.getView().addDependent(this._oDialog)}this._oDialog.open();var t={selection:this.getResourceBundle().getText("fragmentchoiceRelease")};var s=new sap.ui.model.json.JSONModel(t);this.getView().setModel(s,"DialogModel")},handleCancel:function(e){this._oDialog.close()},handleSubmit:function(e){var t=sap.ui.getCore().byId("FragmentNote").getValue();var s=this.getOwnerComponent().getModel("TASKPROCESSING");var o=this.InstanceId;var n="LOCAL_TGW";var r={};r.SAP__Origin=n;r.InstanceID=o;if(sap.ui.getCore().byId("choice").getText()=="Release"||sap.ui.getCore().byId("choice").getText()=="Rilascia"){r.DecisionKey="0001"}else{r.DecisionKey="0002";if(!t){sap.m.MessageBox.warning(this.getResourceBundle().getText("ErrorNoteObb"));return}}this._oDialog.close();r.Comments=t;sap.ui.core.BusyIndicator.show();s.callFunction("/Decision",{method:"POST",urlParameters:r,success:function(e,t){sap.ui.core.BusyIndicator.hide();sap.ui.getCore().byId("FragmentNote").setValue("");i.show(this.getResourceBundle().getText("SuccessSubmit"));this.oEventBus.publish("Detail","selectFirstItemAfter")}.bind(this),error:function(e){sap.ui.core.BusyIndicator.hide();sap.ui.getCore().byId("FragmentNote").setValue("");i.show(this.getResourceBundle().getText("ErrorSubmit"))}.bind(this)})},checkBlocksReject:function(e){if(!this._oDialog){this._oDialog=sap.ui.xmlfragment("invoiceapproval_S4Hana.view.DecisionStep",this);this.getView().addDependent(this._oDialog)}this._oDialog.open();var t={selection:this.getResourceBundle().getText("fragmentchoiceReject")};var s=new sap.ui.model.json.JSONModel(t);this.getView().setModel(s,"DialogModel")},onListUpdateFinished:function(e){var t,s=e.getParameter("total"),i=this.getModel("detailView");if(this.byId("lineItemsList").getBinding("items").isLengthFinal()){if(s){t=this.getResourceBundle().getText("detailLineItemTableHeadingCount",[s])}else{t=this.getResourceBundle().getText("detailLineItemTableHeading")}i.setProperty("/lineItemListTitle",t)}},_onObjectMatched:function(e){var t=e.getParameter("arguments").objectId;var s=e.getParameter("arguments").instanceId;this.oEventBus=this.getOwnerComponent().getEventBus();this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");sap.ui.core.BusyIndicator.show();this.getModel().metadataLoaded().then(function(){var e=this.getModel().createKey("ExtendedPropertiesInvoiceSet",{SAP__Origin:"LOCAL_TGW",InstanceID:s,TaskDefinitionID:t,DocId:""});this._bindView("/"+e)}.bind(this));this.TaskDefinition=t;this.InstanceId=s;this.ReadApproverSetModel(t,s);this.ReadInvoiceAttachment(t,s)},ReadInvoiceAttachment:function(e,t){var s=this.getOwnerComponent().getModel("TASKPROCESSING");var i=t;var o=e;var n="LOCAL_TGW";r=[];var a=new sap.ui.model.Filter("SAP__Origin",sap.ui.model.FilterOperator.EQ,n);r.push(a);var l=new sap.ui.model.Filter("InstanceID",sap.ui.model.FilterOperator.EQ,i);r.push(l);s.read("/TaskCollection(SAP__Origin='%2FIWPGW%2FBWF',InstanceID='"+i+"')/Attachments",{success:function(e){sap.ui.core.BusyIndicator.hide();var t=0;for(t=0;e.results.length>t;t++){var s=e.results[t].__metadata.media_src;var i=s.split("44300/");var o=this.getOwnerComponent().getManifestObject();e.results[t].__metadata.media_src=o._oBaseUri._string+i[1]}var n={Attachments:e.results,AttachmentsCount:e.results.length};var r=new sap.ui.model.json.JSONModel(n);this.getOwnerComponent().setModel(r,"detail")}.bind(this),error:function(e){sap.ui.core.BusyIndicator.hide();alert("Errore di comunicazione con il database.")}.bind(this)})},ReadApproverSetModel:function(e,t){var s=t;var i=e;var o="LOCAL_TGW";var n=new sap.ui.model.Filter("SAP__Origin",sap.ui.model.FilterOperator.EQ,o);r.push(n);var a=new sap.ui.model.Filter("InstanceID",sap.ui.model.FilterOperator.EQ,s);r.push(a);var l=new sap.ui.model.Filter("TaskDefinitionID",sap.ui.model.FilterOperator.EQ,i);r.push(l);var d=this.getOwnerComponent().getModel();d.read("/ExtendedPropertiesInvoiceSet",{urlParameters:{$expand:"Positions,Approvers,Attachments"},filters:[r],success:function(e){sap.ui.core.BusyIndicator.hide();var t=e.results.length-1;var s=function(e){var t=e.split("\\n");return t.join("\n")};if(e.results[t].HeaderNote!=undefined){e.results[t].HeaderNote=s(e.results[t].HeaderNote)}if(e.results[t].ApprRejNote!=undefined){e.results[t].ApprRejNote=s(e.results[t].ApprRejNote)}for(var i=0;e.results[t].Positions.results.length>i;i++){if(e.results[t].Positions.results[i].LongText!=undefined){e.results[t].Positions.results[i].LongText=e.results[t].Positions.results[i].LongText.replace(/\\n/g,"\n")}}e.results[t].HasPurchaseRequest=false;e.results[t].noDiscrepancyItems=true;e.results[t].showAllRowsDiscrepancy=false;for(var o=0;o<e.results[t].Positions.results.length;o++){e.results[t].Positions.results[o].showAllRows=false;if(e.results[t].PriceDiscrepancy==="X"&&e.results[t].Positions.results[o].Position!==e.results[t].DiscrepancyRow){e.results[t].Positions.results[o].noDiscrepancy=true;e.results[t].noDiscrepancyItems=false;if(e.results[t].Positions.results[o].Type==="1WT_DIS"){e.results[t].Positions.results[o].Type="2NO_DIS"}}else{e.results[t].Positions.results[o].noDiscrepancy=false}}var n=[];for(var r=0;e.results[t].Attachments.results.length>r;r++){var a=e.results[t].Attachments.results[r].__metadata.uri.split("44301/");var l=this.getOwnerComponent().getManifestObject();var d=l._oBaseUri._string+a[1];d.replace("AttachmentSet","ActualAttachmentSet");var u=d.split("AttachmentSet");a=[];a=d.split("(");a=a[1].split(",");d=u[0]+"ActualAttachmentSet("+a[3]+","+a[4]+"/$value";e.results[t].Attachments.results[r].__metadata.uri=d}var c=new sap.ui.model.json.JSONModel({Attachments:e.results[t].Attachments.results,AttachmentsCount:e.results[t].Attachments.results.length});this.getView().setModel(c,"detail");this.extendedJsonModel=new sap.ui.model.json.JSONModel(e.results[t]);this.getView().setModel(this.extendedJsonModel,"extendedJsonModel");this.flowGenerator(e.results[t].Approvers.results)}.bind(this),error:function(e){sap.ui.core.BusyIndicator.hide();alert("Errore di comunicazione con il database.")}.bind(this)})},flowGenerator:function(e){var t=this.getView().byId("approvingStepsArea");t.destroyItems();while(e.length){var s=e.filter(function(t){return e[0].PurchaseRequisition===t.PurchaseRequisition});var e=e.filter(function(e){return s[0].PurchaseRequisition!==e.PurchaseRequisition});var i=new o({});t.addItem(i);i.setData(s)}},_bindView:function(e){var t=this.getModel("detailView");t.setProperty("/busy",false);this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){t.setProperty("/busy",true)},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=e.getElementBinding();if(!t.getBoundContext()){this.getRouter().getTargets().display("detailObjectNotFound");this.getOwnerComponent().oListSelector.clearMasterListSelection();return}var s=t.getPath(),i=this.getResourceBundle();this.getOwnerComponent().oListSelector.selectAListItem(s)},_onMetadataLoaded:function(){var e=this.getView().getBusyIndicatorDelay(),t=this.getModel("detailView"),s=this.byId("TablePosition"),i=s.getBusyIndicatorDelay();t.setProperty("/delay",0);t.setProperty("/lineItemTableDelay",0);s.attachEventOnce("updateFinished",function(){t.setProperty("/lineItemTableDelay",i)});t.setProperty("/busy",true);t.setProperty("/delay",e)},onCloseDetailPress:function(){this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",false);this.getOwnerComponent().oListSelector.clearMasterListSelection();this.getRouter().navTo("master")},toggleFullScreen:function(){var e=this.getModel("appView").getProperty("/actionButtonsInfo/midColumn/fullScreen");this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",!e);if(!e){this.getModel("appView").setProperty("/previousLayout",this.getModel("appView").getProperty("/layout"));this.getModel("appView").setProperty("/layout","MidColumnFullScreen")}else{this.getModel("appView").setProperty("/layout",this.getModel("appView").getProperty("/previousLayout"))}}})});