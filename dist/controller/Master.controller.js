sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/Sorter","sap/ui/model/FilterOperator","sap/m/GroupHeaderListItem","sap/ui/Device","sap/ui/core/Fragment","../model/formatter"],function(e,t,i,s,r,n,a,o,l){"use strict";var u="";var h=[];return e.extend("invoiceapproval_S4Hana.controller.Master",{formatter:l,onInit:function(){var e=this.byId("list"),t=this._createViewModel(),i=e.getBusyIndicatorDelay();e.setBusy(true);var s=this;Promise.all([this.getTaskProcessing()]).then(s.getInvoiceProperties.bind(s));this._oList=e;this._oListFilterState={aFilter:[],aSearch:[]};this.setModel(t,"masterView");e.attachEventOnce("updateFinished",function(){t.setProperty("/delay",i)});this.getView().addEventDelegate({onBeforeFirstShow:function(){this.getOwnerComponent().oListSelector.setBoundMasterList(e)}.bind(this)});this.getRouter().getRoute("master").attachPatternMatched(this._onMasterMatched,this);this.getRouter().attachBypassed(this.onBypassed,this);var r=this.getOwnerComponent().getEventBus();r.subscribe("Detail","selectFirstItemAfter",this.selectFirstItemAfter,this)},displayFirst:function(e){var t=this.getView().byId("list").getItems();var i="";if(t){i=t[0];if(i!=undefined){this._showDetail(i)}}},selectFirstItemAfter:function(){var e=!a.system.phone;var t=this;Promise.all([this.getTaskProcessing()]).then(t.getInvoiceProperties.bind(t));this.getRouter().getTargets().display("detailObjectNotFound")},refreshData:function(){oList.setBusy(true);var e=this;Promise.all([this.getTaskProcessing()]).then(e.getInvoiceProperties.bind(e))},getInvoiceProperties:function(e){var i=this.getOwnerComponent().getModel();i.read("/ExtendedPropertiesInvoiceSet",{filters:[h],success:function e(i,s){var r=0,n=0,a=[],o={};a=[];for(r=0;r<i.results.length;r++){for(n=0;n<this.TaskProcessingResult.length;n++){if(i.results[r].InstanceID==this.TaskProcessingResult[n].InstanceID){o={};o.DocTypeDesc=i.results[r].DocTypeDesc;o.InstanceID=i.results[r].InstanceID;o.VendorName=i.results[r].VendorName;o.InvoiceNumber=i.results[r].InvoiceNumber;o.Date=i.results[r].Date;o.NetAmount=i.results[r].NetAmount;o.ToBeApproved=i.results[r].ToBeApproved;o.Currency=i.results[r].Currency;o.TaskDefinitionID=this.TaskProcessingResult[n].TaskDefinitionID;o.CreatedBy=this.TaskProcessingResult[n].CreatedBy;o.Priority=this.TaskProcessingResult[n].Priority;o.Title=this.TaskProcessingResult[n].Title;o.DueOn=this.TaskProcessingResult[n].DueOn;o.CreatedOn=this.TaskProcessingResult[n].CreatedOn;o.Status=this.TaskProcessingResult[n].Status;o.Reservation=this.TaskProcessingResult[n].Reservation;o.Type=this.TaskProcessingResult[n].Type;a.push(o)}}}var l={Task:a};var u=new sap.ui.model.json.JSONModel(l);sap.ui.core.BusyIndicator.hide();this.getOwnerComponent().setModel(u,"modelMaster");var h=new t({isFilterBarVisible:false,filterBarLabel:"",delay:0,title:this.getResourceBundle().getText("masterTitleCount",[i.results.length]),noDataText:this.getResourceBundle().getText("masterListNoDataText"),sortBy:"PurchaseRequisition",groupBy:"None"});this.getView().setModel(h,"masterView");if(this.getView().byId("list")!=undefined){this.getView().byId("list").setBusy(false);this.displayFirst()}this.getView().byId("list").setBusy(false)}.bind(this),error:function e(i){var s=new t({isFilterBarVisible:false,filterBarLabel:"",delay:0,title:this.getResourceBundle().getText("masterTitleCount",[0]),noDataText:this.getResourceBundle().getText("masterListNoDataText"),sortBy:"PurchaseRequisition",groupBy:"None"});sap.ui.core.BusyIndicator.hide();this.getView().setModel(s,"masterView");this.getView().byId("list").setBusy(false)}.bind(this)})},getTaskProcessing:function(e){var t={};var i=0;var s=0;var r=this.getOwnerComponent().getModel("TASKPROCESSING");r.refresh();h=[];sap.ui.core.BusyIndicator.show();return new Promise(function(e,t){r.read("/TaskCollection?$skip=0&$top=9999&$orderby=CreatedOn%20asc&$filter=TaskDefinitionID eq 'TS90000087_WS00275253_0000000071' and (Status eq 'READY' or Status eq 'RESERVED' or Status eq 'IN_PROGRESS' or Status eq 'EXECUTED')",{success:function t(s,r){var n=s.results;this.TaskProcessingResult=[];for(i=0;i<n.length;i++){if((n[i].TaskDefinitionID=="TS90000090_WS00275264_0000000182"||n[i].TaskDefinitionID=="TS90000087_WS00275253_0000000071"||n[i].TaskDefinitionID=="TS00008267_WS00275253_0000000083"||n[i].TaskDefinitionID=="TS00275278"||n[i].TaskDefinitionID=="TS00008267_WS00275264_0000000213")&&(n[i].Status=="READY"||n[i].Status=="RESERVED"||n[i].Status=="IN_PROGRESS"||n[i].Status=="EXECUTED")){var a=new sap.ui.model.Filter("InstanceID",sap.ui.model.FilterOperator.EQ,n[i].InstanceID);h.push(a);this.TaskProcessingResult.push(n[i])}}e(s);sap.ui.core.BusyIndicator.hide()}.bind(this),error:function e(i){sap.ui.core.BusyIndicator.hide();t(i)}.bind(this)})}.bind(this))},onUpdateFinished:function(e){this._updateListItemCount(e.getParameter("total"))},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.refreshData();return}var t=e.getParameter("query");if(t){this._oListFilterState.aSearch=new i({filters:[new i("PurchaseRequisition",r.Contains,t),new i("TipoDocumentoDesc",r.Contains,t),new i("RequesterDesc",r.Contains,t),new i("TotalValue",r.Contains,t),new i("Currency",r.Contains,t)],and:false})}else{this._oListFilterState.aSearch=[]}var s=this._oListFilterState.aSearch,n=this.getModel("masterView");this._oList.getBinding("items").filter(s,"Application");if(s.length!==0){n.setProperty("/noDataText",this.getResourceBundle().getText("masterListNoDataWithFilterOrSearchText"))}else if(this._oListFilterState.aSearch.length>0){n.setProperty("/noDataText",this.getResourceBundle().getText("masterListNoDataText"))}},onRefresh:function(){this._oList.getBinding("items").refresh()},onOpenViewSettings:function(e){var t="filter";if(e.getSource()instanceof sap.m.Button){var i=e.getSource().getId();if(i.match("sort")){t="sort"}else if(i.match("group")){t="group"}}if(!this.byId("viewSettingsDialog")){o.load({id:this.getView().getId(),name:"invoiceapproval_S4Hana.view.ViewSettingsDialog",controller:this}).then(function(e){this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());e.open(t)}.bind(this))}else{this.byId("viewSettingsDialog").open(t)}},onOpenViewFilter:function(e){var t="filter";if(!this.byId("viewFilterDialog")){o.load({id:this.getView().getId(),name:"invoiceapproval_S4Hana.view.FilterDialog",controller:this}).then(function(e){this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());e.open(t)}.bind(this))}else{this.byId("viewFilterDialog").open(t)}},onOpenGroupFilter:function(e){var t="Group";if(!this.byId("viewGroupDialog")){o.load({id:this.getView().getId(),name:"invoiceapproval_S4Hana.view.GroupFilter",controller:this}).then(function(e){this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());e.open(t)}.bind(this))}else{this.byId("viewGroupDialog").open(t)}},onConfirmViewSettingsDialog:function(e){this._applySortGroup(e)},_applySortGroup:function(e){var t=e.getParameters(),i,r,n=[];i=t.sortItem.getKey();r=t.sortDescending;n.push(new s(i,r));this._oList.getBinding("items").sort(n)},onSelectionChange:function(e){var t=e.getSource(),i=e.getParameter("selected");if(!(t.getMode()==="MultiSelect"&&!i)){this._showDetail(e.getParameter("listItem")||e.getSource())}},onBypassed:function(){this._oList.removeSelections(true)},createGroupHeader:function(e){return new n({title:e.text,upperCase:false})},onNavBack:function(){history.go(-1)},_createViewModel:function(){return new t({isFilterBarVisible:false,filterBarLabel:"",delay:0,title:this.getResourceBundle().getText("masterTitleCount",[0]),noDataText:this.getResourceBundle().getText("masterListNoDataText"),sortBy:"PurchaseRequisition",groupBy:"None"})},_onMasterMatched:function(){this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded")},_showDetail:function(e){var t=!a.system.phone;this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");this.getRouter().navTo("object",{objectId:e.getContent()[0].getItems()[0].getItems()[3].getText(),instanceId:e.getContent()[0].getItems()[0].getItems()[2].getText()},t)},_updateListItemCount:function(e){var t;if(this._oList.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("masterTitleCount",[e]);this.getModel("masterView").setProperty("/title",t)}},_applyFilterSearch:function(){var e=this._oListFilterState.aSearch.concat(this._oListFilterState.aFilter),t=this.getModel("masterView");this._oList.getBinding("items").filter(e,"Application");if(e.length!==0){t.setProperty("/noDataText",this.getResourceBundle().getText("masterListNoDataWithFilterOrSearchText"))}else if(this._oListFilterState.aSearch.length>0){t.setProperty("/noDataText",this.getResourceBundle().getText("masterListNoDataText"))}},_updateFilterBar:function(e){var t=this.getModel("masterView");t.setProperty("/isFilterBarVisible",this._oListFilterState.aFilter.length>0);t.setProperty("/filterBarLabel",this.getResourceBundle().getText("masterFilterBarText",[e]))}})});